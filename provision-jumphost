#!/usr/bin/env ansible-playbook
# (c) 2016 DataNexus Inc.  All Rights Reserved.
#
# main routine for provisioning jumphosts
---
- name: JUMPHOST | launching VM
  vars_files:
    - "{{ configuration }}"
    - vars/jumphost.yml
  hosts: localhost
  connection: local
  gather_facts: true
  tasks:
    - include_role:
        name: aws
      when: cloud == 'aws'
          
    - include_role:
        name: azure
      when: cloud == 'azure'
   
#    - { role: osp, when: cloud == 'osp' }

- name: JUMPHOST OVERLAY | building host groups
  vars_files:
    - "{{ configuration }}"  
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - include_role:
        name: aws
        tasks_from: discover-vm
      when: cloud == 'aws'
      
    - include_role:
        name: azure
        tasks_from: discover-vm
      when: cloud == 'azure'
    
    - include_role:
        name: jumphost
        tasks_from: modify-sshconfig    
      
# this is a separate step because ansible needs to gather facts on a fully configured base system
- name: JUMPHOST OVERLAY | completing OS configuration
  hosts: "{{ application }}"
  vars_files:
    - "{{ configuration }}"
    - vars/jumphost.yml
  gather_facts: yes
  tasks:
    - include_role:
        name: preflight
    - include_role:
        name: http-proxy
      when: http_proxy is defined
